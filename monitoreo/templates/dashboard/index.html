{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Proyecto Sonora</title>

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

    <!-- Lucide Icons -->
    <script type="module">
        import { Thermometer, Droplets, Gauge } from 'https://cdn.jsdelivr.net/npm/lucide-esm@latest/umd/lucide-esm.js';
        window.lucide = { Thermometer, Droplets, Gauge };
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 p-6 min-h-screen">

    <header class="text-center mb-10">
        <h1 class="text-4xl font-extrabold text-gray-800">
            Dashboard de Monitoreo <span class="text-indigo-600">Sonora</span>
        </h1>
        <p class="text-lg text-gray-500">Visualización de lecturas históricas.</p>
    </header>

    <section class="max-w-6xl mx-auto bg-white p-8 rounded-2xl shadow-xl border border-gray-100">

        <h2 id="section-title" class="text-2xl font-semibold text-gray-800 border-b pb-3 mb-6 flex items-center gap-2">
            Cargando...
        </h2>

        <!-- Filtros -->
        <div class="flex flex-wrap gap-8 mb-8">
            <div>
                <label class="text-sm font-medium text-gray-600">Municipio:</label>
                <select id="select-municipio"
                    class="p-2 border rounded-lg focus:ring-indigo-500 bg-white cursor-pointer">
                    <option>Hermosillo</option>
                    <option>Cajeme</option>
                    <option>Guaymas</option>
                    <option>Nogales</option>
                </select>
            </div>

            <div>
                <label class="text-sm font-medium text-gray-600">Tipo de Dato:</label>
                <select id="select-tipo"
                    class="p-2 border rounded-lg focus:ring-indigo-500 bg-white cursor-pointer">
                    <option value="temperatura">Temperatura (°C)</option>
                    <option value="humedad">Humedad (%)</option>
                    <option value="presion">Presión (hPa)</option>
                </select>
            </div>
        </div>

        <!-- Gráfica -->
        <div class="relative h-96 p-4 bg-gray-50 border rounded-lg">
            <canvas id="lecturasChart"></canvas>

            <div id="loading-overlay"
                class="absolute inset-0 bg-white bg-opacity-80 hidden flex-col items-center justify-center text-indigo-600">
                <svg class="w-8 h-8 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 2v4m0 12v4m10-10h-4M6 12H2m15.364 7.364l-2.828-2.828M8.464 8.464L5.636 5.636m12.728 0l-2.828 2.828M8.464 15.536l-2.828 2.828" />
                </svg>
                <p class="mt-2 font-medium">Cargando datos...</p>
            </div>
        </div>


    </section>

    {% verbatim %}
    <script>
        const TIPOS_DATO = {
            temperatura: { label: "Temperatura (°C)", unit: "°C", min: 20, max: 45, color: "#ef4444" },
            humedad: { label: "Humedad (%)", unit: "%", min: 30, max: 70, color: "#3b82f6" },
            presion: { label: "Presión (hPa)", unit: "hPa", min: 990, max: 1020, color: "#10b981" },
        };

        let currentChart = null;
        let currentMunicipio = "Hermosillo";
        let currentTipoDato = "temperatura";

        const chartCanvas = document.getElementById("lecturasChart");
        const loadingOverlay = document.getElementById("loading-overlay");
        const selectMunicipio = document.getElementById("select-municipio");
        const selectTipo = document.getElementById("select-tipo");
        const sectionTitle = document.getElementById("section-title");

        function generateData(tipoDato) {
            const config = TIPOS_DATO[tipoDato];
            const labels = [];
            const dataPoints = [];
            let d = new Date();
            d.setDate(d.getDate() - 7);

            for (let i = 0; i < 24 * 7; i++) {
                labels.push(d.toLocaleString("es-MX", { hour: '2-digit', day: '2-digit', month: 'short' }));

                const base = (config.min + config.max) / 2;
                const noise = (Math.random() - 0.5) * (config.max - config.min) * 0.4;
                dataPoints.push(base + noise);

                d.setHours(d.getHours() + 1);
            }
            return { labels, dataPoints };
        }

        function renderChart() {
            const data = generateData(currentTipoDato);
            const cfg = TIPOS_DATO[currentTipoDato];

            if (currentChart) currentChart.destroy();

            currentChart = new Chart(chartCanvas, {
                type: "line",
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: `${cfg.label} en ${currentMunicipio}`,
                        data: data.dataPoints,
                        borderColor: cfg.color,
                        backgroundColor: cfg.color + "22",
                        tension: 0.3,
                        pointRadius: 0,
                        borderWidth: 2,
                        fill: true
                    }],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            sectionTitle.textContent = `${cfg.label} en ${currentMunicipio}`;
        }

        function loadChart() {
            loadingOverlay.classList.remove("hidden");
            setTimeout(() => {
                renderChart();
                loadingOverlay.classList.add("hidden");
            }, 500);
        }

        selectMunicipio.onchange = e => {
            currentMunicipio = e.target.value;
            loadChart();
        };

        selectTipo.onchange = e => {
            currentTipoDato = e.target.value;
            loadChart();
        };

        window.onload = () => loadChart();
    </script>
    {% endverbatim %}
</body>
</html>
